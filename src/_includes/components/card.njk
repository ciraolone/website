{#
  Componente Card Riutilizzabile (Stile Neobrutalista)

  Parametri:
  - image: percorso immagine (opzionale, alt. a video/iframe)
  - video: percorso video (opzionale, alt. a image/iframe)
  - iframe: URL iframe (opzionale, alt. a image/video)
  - iframeHeight: altezza iframe (default: "320px")
  - imageAlt: testo alternativo per immagine
  - logo: percorso logo/icona (opzionale, mostrato sopra al titolo)
  - headerText: testo header giallo (opzionale, mostra header solo se presente)
  - title: titolo della card (opzionale, supporta markdown inline)
  - description: descrizione della card (opzionale, supporta markdown inline: **grassetto**, *corsivo*, ~~barrato~~, etc.)
  - buttonText: testo pulsante (opzionale)
  - buttonUrl: URL pulsante (opzionale)
  - buttonVariant: "primary" o "secondary" (default: "primary")
  - cardUrl: URL card cliccabile (opzionale)
  - className: classi CSS aggiuntive card (opzionale)
  - imageClassName: classi CSS aggiuntive immagine (opzionale)
  - videoClassName: classi CSS aggiuntive video (opzionale)
  - showHeader: mostra header (default: true se headerText presente)
  - mediaPosition: "top" (default), "bottom", "left", "right"
    Mobile (<640px): sempre verticale
    Desktop (â‰¥640px): orizzontale con media larghezza fissa 320px (w-64)
  - textAlign: "left" (default), "center", "right"

  Uso: {% raw %}{% from "components/card.njk" import card %}{% endraw %}

  Esempi:
  - card(video="/path.mp4", headerText="Titolo")
  - card(title="Centrato", textAlign="center")
  - card(image="/img.jpg", mediaPosition="bottom")
  - card(image="/img.jpg", mediaPosition="left")
  - card(video="/vid.mp4", mediaPosition="right")
  - card(iframe="https://example.com", mediaPosition="left")
#}

{# Macro per renderizzare media (elimina duplicazione) #}
{% macro renderMedia(
  type,
  src,
  alt,
  mediaClass,
  mediaElClass,
  iframeHeight
) %}
  {%- if type -%}
  <div class="{{ mediaClass }}">
    {%- if type == "video" -%}
    <video autoplay loop muted playsinline
      class="{{ mediaElClass }}">
      <source src="{{ src }}" type="video/mp4">
    </video>
    {%- elif type == "image" -%}
    <img src="{{ src }}" alt="{{ alt }}"
      class="{{ mediaElClass }}" loading="lazy">
    {%- elif type == "iframe" -%}
    <iframe src="{{ src }}" width="100%"
      height="{{ iframeHeight }}"
      style="border:0; background:transparent; margin:0; padding:0;"
      frameborder="0" scrolling="no" class="block max-w-full">
    </iframe>
    {%- endif -%}
  </div>
  {%- endif -%}
{% endmacro %}

{% macro card(
  video="",
  image="",
  iframe="",
  iframeHeight="320px",
  imageAlt="",
  logo="",
  headerText="",
  title="",
  description="",
  buttonText="",
  buttonUrl="",
  buttonVariant="primary",
  cardUrl="",
  className="",
  imageClassName="",
  videoClassName="",
  showHeader=true,
  mediaPosition="top",
  textAlign="left"
) %}

{# Variabili base #}
{% set mediaType = (
  "video" if video else
  ("image" if image else ("iframe" if iframe else ""))
) %}
{% set mediaSrc = video or image or iframe %}
{% set hasHeader = (
  showHeader !== false and headerText
) %}

{# Mappa configurazione per posizione media
   Breakpoint: sm (640px) - mobile verticale, desktop orizzontale
   Layout orizzontale: media larghezza fissa 320px (w-64), content occupa spazio rimanente (flex-1)
#}
{% set layoutMap = {
  "top": {
    "container": "flex flex-col",
    "mediaWidth": "w-full",
    "mediaOrder": "",
    "contentOrder": "",
    "mediaBorder": "border-b-2",
    "contentBorder": "",
    "mediaResponsive": "",
    "contentResponsive": ""
  },
  "bottom": {
    "container": "flex flex-col",
    "mediaWidth": "w-full",
    "mediaOrder": "order-2",
    "contentOrder": "order-1",
    "mediaBorder": "border-t-2",
    "contentBorder": "",
    "mediaResponsive": "",
    "contentResponsive": ""
  },
  "left": {
    "container": "flex flex-col sm:flex-row",
    "mediaWidth": "w-full sm:w-64",
    "mediaOrder": "",
    "contentOrder": "",
    "mediaBorder": "border-b-2 sm:border-b-0 sm:border-r-2",
    "contentBorder": "",
    "mediaResponsive": "sm:self-stretch sm:h-full",
    "contentResponsive": "sm:flex-1 sm:flex sm:flex-col sm:justify-center"
  },
  "right": {
    "container": "flex flex-col sm:flex-row-reverse",
    "mediaWidth": "w-full sm:w-64",
    "mediaOrder": "",
    "contentOrder": "",
    "mediaBorder": "border-b-2 sm:border-b-0 sm:border-l-2",
    "contentBorder": "",
    "mediaResponsive": "sm:self-stretch sm:h-full",
    "contentResponsive": "sm:flex-1 sm:flex sm:flex-col sm:justify-center"
  }
} %}

{% set layout = layoutMap[mediaPosition] %}

{# Mappa allineamento testo #}
{% set alignMap = {
  "left": "text-left",
  "center": "text-center",
  "right": "text-right"
} %}
{% set alignClass = alignMap[textAlign] or "text-left" %}

{# Costruisci classi media #}
{% set bgColor = (
  "bg-white" if mediaType == "iframe" else "bg-black"
) %}
{% set mediaClass = (
  layout.mediaWidth + " " + layout.mediaBorder +
  " border-black " + bgColor + " overflow-hidden " +
  layout.mediaOrder
) %}
{% if mediaPosition == "left" or mediaPosition == "right" %}
  {% set mediaClass = mediaClass + " " + layout.mediaResponsive %}
{% else %}
  {% set mediaClass = mediaClass + " leading-[0]" %}
{% endif %}

{# Costruisci classi elemento media (video/img) #}
{% set baseElClass = (
  "w-full block max-w-full " +
  (videoClassName if mediaType == "video" else imageClassName)
) %}
{% if mediaPosition == "left" or mediaPosition == "right" %}
  {% set mediaElClass = baseElClass + " sm:object-cover" %}
{% else %}
  {% set mediaElClass = baseElClass + " h-auto" %}
{% endif %}

{# Costruisci classi content
   ATTENZIONE: NON aggiungere 'w-full' qui - crea conflitto con flex-1
   nei layout orizzontali. 'prose' ha max-width implicita, quindi serve
   'max-w-none' per evitare limitazioni indesiderate con flex-1.
#}
{% set contentClass = (
  layout.contentBorder + " border-black p-4 sm:p-6 max-w-none " +
  layout.contentOrder + " " + layout.contentResponsive + " " + alignClass
) %}

{# Container card - inline per evitare tag <p> da Markdown #}
<div class="w-full border-2 border-black bg-white shadow not-prose overflow-hidden rounded-default {{ className }} {{ 'relative hover:shadow transition-shadow cursor-pointer' if cardUrl else '' }}">{%- if cardUrl -%}
<a href="{{ cardUrl }}" class="absolute inset-0 z-10" aria-label="{{ title or 'Card link' }}"></a>
{%- endif -%}
{%- if hasHeader -%}
<div class="p-3 bg-primary border-b-2 border-black">
  <div class="flex items-center justify-between">
    <strong class="text-xs/none font-bold uppercase">
      {{- headerText -}}
    </strong>
    <div class="flex gap-1">
      <div class="size-3 border-2 border-black bg-white"></div>
      <div class="size-3 border-2 border-black bg-white"></div>
    </div>
  </div>
</div>
{%- endif -%}

<div class="{{ layout.container }}">
  {{- renderMedia(
    mediaType,
    mediaSrc,
    imageAlt or title or 'Immagine card',
    mediaClass,
    mediaElClass,
    iframeHeight
  ) -}}

  {%- if title or description or buttonText or logo -%}
  <div class="{{ contentClass }}">
     {%- if logo or title or description -%}
    <div class="prose">
    {%- if logo -%}
    <img src="{{ logo }}" alt="{{ title or 'Logo' }}" class="w-12 h-12 mb-3 object-contain mb-3">
    {%- endif -%}
    {%- if title -%}
    <h3 class="text-lg font-semibold text-black font-accent">
    {{- title | md | safe -}}
    </h3>
    {%- endif -%}
    {%- if description -%}
    <p>{{ description | md | safe }}</p>
    {%- endif -%}
    </div>
    {%- endif -%}
    {%- if buttonText and buttonUrl -%}
    <div class="mt-5 not-prose {{ 'text-right' if mediaPosition == 'left' else '' }}">
      <a href="{{ buttonUrl }}"
        class="relative z-20 inline-block border-2 border-black px-5 py-3
        font-semibold text-black shadow
        focus:outline-0 transition-colors duration-300
        bg-primary hover:bg-primary-dark
        focus-ring-primary rounded-default">
        {{- buttonText -}}
      </a>
    </div>
    {%- endif -%}
  </div>
  {%- endif -%}
</div>
</div>
{% endmacro %}
